---
title: "Node JS #8"

excerpt: "CRUD implement, Syn vs Asyn, validation check, M/W and static in mongoose"

categories:
  - webBase
---



# File Management : server.jsì™€ init.js

í”„ë¡œì íŠ¸ íŒŒì¼ì´ ì»¤ì§€ë©´ì„œ ì½”ë“œê°€ ê¸¸ì–´ì§„ë‹¤.

ì„œë²„ ê´€ë ¨ ë˜í•œ ë§ˆì°¬ê°€ì§€. server.jsì™€ init.jsë¡œ ë¶„í• í•˜ì.

> **server.js**
>
> - ì„œë²„ì˜ ì„¤ì • ë‹´ë‹¹
>
> **init.js**
>
> - ì„œë²„ì˜ ì´ˆê¸°í™” ë‹´ë‹¹



ì•„ë˜ëŠ” ê° íŒŒì¼ì˜ ì½”ë“œ

```js
//server.js (ì„œë²„ì˜ ì„¤ì • ë‹´ë‹¹í•˜ëŠ” íŒŒì¼)

//import
import express from "express";
import morgan from "morgan";
import globalRouter from "./routers/globalRouter";
import userRouter from "./routers/userRouter";
import videoRouter from "./routers/videoRouter";


//configure server application
const app = express(); // application ìƒì„±
const logger = morgan("dev"); // morgan m/w ìƒì„±
app.use(logger); // m/w ë“±ë¡
app.set("view engine", "pug"); // view ì—”ì§„ ë“±ë¡
app.set("views", process.cwd() + "/src/views"); // view ê²½ë¡œ ë“±ë¡
app.use(express.urlencoded({ extended: true })); // req.body ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ m/w ë“±ë¡

//router ë“±ë¡
app.use("/", globalRouter);
app.use("/videos", videoRouter);
app.use("/users", userRouter);

export default app;
```

```js
//init.js
import "./db"; // db íŒŒì¼ import
import "./models/Video"; // Video model import
import app from "./server"; // app import

// ì„œë²„ ê°€ë™
const PORT = 4000;
const handleListening = () =>
  console.log(
    `ğŸš€ Server listening on port http://localhost:${PORT}`
  );

app.listen(4000, handleListening);

```



ê·¸ë¦¬ê³  íŒŒì¼ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì•„ë˜ ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  ì‹¶ë‹¤ë©´

```bash
> npm run dev
```

ì•„ë˜ì™€ ê°™ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³€ê²½í•´ì£¼ì (ì„œë²„ ê°€ë™ íŒŒì¼ì´ init.jsë¡œ ë³€ê²½ë˜ì—ˆê¸° ë•Œë¬¸)

```js
//package.json
...
"scripts": {
    "dev": "nodemon --exec babel-node src/init.js"
  },
...
```



---



# How to CRUD



## Read

ë¹„ë””ì˜¤ ëª¨ë¸ì´ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜ë˜ì–´ ìˆë‹¤.

```js
//src/movels/Video.js
import mongoose from "mongoose";

const videoSchema = new mongoose.Schema({
  title: { type: String, required: true, trim: true, maxLength: 80 },
  description: { type: String, required: true, trim: true, minLength: 20 },
  createdAt: {
    type: Date,
    required: true,
    default: Date.now,
  },
  hashtags: [{ type: String, trim: true }],
  meta: {
    views: { type: Number, default: 0 },
    rating: { type: Number, default: 0 },
  },
});

videoSchema.static("formatHashtags", function (hashtags) {
  return hashtags
    .split(",")
    .map((word) => (word.startsWith("#") ? word : `#${word}`));
});

const Video = mongoose.model("Video", videoSchema);
export default Video;

```



DBì— ìœ„ì™€ ê°™ì€ ë¹„ë””ì˜¤ë“¤ì´ ì €ì¥ë˜ì–´ ìˆì„ ê²½ìš°, ì´ë¥¼ ëª¨ë‘ êº¼ë‚´ì„œ ë³¼ ìˆ˜ ìˆê²Œ í•˜ì.(Read)

```js
import Video from "../models/Video";
export const home = async (req, res) => {
  const videos = await Video.find({}).sort({ createdAt: "desc" });
  return res.render("home", {
    pageTitle: "Home",
    videos,
  });
};
```



ìœ„ ì½”ë“œë¥¼ í•´ì„í•˜ê¸° ìœ„í•´ ëª‡ê°€ì§€ ê°œë…ë“¤ì„ ì‚´í´ë³´ì

### ë™ê¸°(Synchronous) vs ë¹„ë™ê¸°(Asynchronous)

![](https://velog.velcdn.com/images%2Fslobber%2Fpost%2F0722db09-f9f9-4f61-8708-4e9d53924fee%2F%E1%84%83%E1%85%A1%E1%84%8B%E1%85%AE%E1%86%AB%E1%84%85%E1%85%A9%E1%84%83%E1%85%B3%20(1).jpeg)



ë™ê¸°(Synchronous)ë€ ì½”ë“œê°€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë§í•œë‹¤

ë¹„ë™ê¸°(Asynchronous)ë€ ì½”ë“œê°€ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë§í•œë‹¤. JSì˜ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤(DB)ì— ì ‘ê·¼í• ë•Œ ìì£¼ ì‚¬ìš©. ì´ë•Œ ì½œë°±í•¨ìˆ˜ë¥¼ ì „ë‹¬í•˜ì—¬ í•´ë‹¹ ì‘ì—…ì´ ëë‚˜ê³  ì‹¤í–‰í•´ì•¼í•  ê²ƒì„ ì•Œë ¤ì¤€ë‹¤.



ìš°ë¦¬ëŠ” DBì— ì ‘ê·¼í•  ê²ƒì´ë¯€ë¡œ ë¹„ë™ê¸°ì  í•¨ìˆ˜ë¥¼ ì‘ì„±í•  ê²ƒì¸ë°, ë¹„ë™ê¸°ì  ì½”ë“œì™€ ê´€ë ¨ëœ ì—­ì‚¬ê°€ ìˆë‹¤(ì½œë°±í—¬->promise->async,await)

ê·¸ëŸ¬ë‚˜ ìì„¸í•œê²ƒì€ ë‚˜ì¤‘ì— ì•Œì•„ë³´ë„ë¡ í•˜ê³ , **async,awaitê°€ ë¹„ë™ê¸°ì  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ê°€ì¥ ìµœì‹  ìŠ¤íƒ€ì¼ì¸ ê²ƒ ì •ë„ë§Œ ì•Œì•„ë‘ê³  ì´ë¥¼ ì´ìš©í•˜ì.**

[MDN : Async function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function)

awaitëŠ” ë¹„ë™ê¸°ì  ì‹¤í–‰ì„ í•˜ê³ ì í• ë•Œ ì“°ëŠ” í‚¤ì›Œë“œì´ê³ , awaitë¥¼ ì“°ê¸° ìœ„í•´ì„œëŠ” í•´ë‹¹ í•¨ìˆ˜ë¥¼ asyn í•¨ìˆ˜ë¡œ ì‚¬ìš©í•´ì•¼í•œë‹¤.



### find()

DBì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ì°¾ê¸° ìœ„í•´ì„œëŠ” DBì— ê²€ìƒ‰í•´ì•¼í•œë‹¤. find()ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆë‹¤.

[MongoDB : find()](https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#std-label-find-projection)

> The [`find()`](https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#mongodb-method-db.collection.find) method has the following form:
>
> ```
> db.collection.find( <query>, <projection>, <options> )
> ```
>
> The [`find()`](https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#mongodb-method-db.collection.find) method takes the following parameters:
>
> | Parameter                                                    | Type     | Description                                                  |
> | :----------------------------------------------------------- | :------- | :----------------------------------------------------------- |
> | [query](https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#std-label-method-find-query) | document | Optional. Specifies selection filter using [query operators](https://www.mongodb.com/docs/manual/reference/operator/query/#std-label-query-projection-operators-top). To return all documents in a collection, omit this parameter or pass an empty document (`{}`). |
> | [projection](https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#std-label-method-find-projection) | document | Optional. Specifies the fields to return in the documents that match the query filter. To return all fields in the matching documents, omit this parameter. For details, see [Projection.](https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#std-label-find-projection) |
> | [options](https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#std-label-method-find-options) | document | Optional. Specifies additional options for the query. These options modify query behavior and how results are returned. To see available options, see [FindOptions.](https://mongodb.github.io/node-mongodb-native/4.0//interfaces/findoptions.html) |



ì½”ë“œë¥¼ ë‹¤ì‹œ ì‚´í´ë³´ì

```js
export const home = async (req, res) => { // awaitë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ async í‚¤ì›Œë“œ 
  const videos = await Video.find({}).sort({ createdAt: "desc" }); // DBì˜ ëª¨ë“  Video ë°ì´í„°ë“¤ì„ êº¼ë‚´ì„œ ì œì‘ì¼ì ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  return res.render("home", {
    pageTitle: "Home",
    videos,
  });
};
```



ë§Œì¼, ë¹„ë™ê¸°ì  ë°©ì‹ì„ ì·¨í•˜ì§€ ì•Šì•˜ë‹¤ë©´?

```js
//sync, await í‚¤ì›Œë“œ ì œê±° -> ë™ê¸°ì  ì‹¤í–‰
export const home =(req, res) => { 
  const videos = Video.find({}).sort({ createdAt: "desc" });
  return res.render("home", {
    pageTitle: "Home",
    videos,
  });
};
```

![image](https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/c0cbee76-b44a-4730-ba61-3058d292e934)

ë‹¤ìŒê³¼ ê°™ì´ ì—ëŸ¬ ë°œìƒ



**ì™œëƒí•˜ë©´, DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ì€ ì‹œê°„ì´ ì†Œìš”ë˜ì§€ë§Œ await í‚¤ì›Œë“œë¡œ ì¸í•´ ê¸°ë‹¤ë¦¬ì§€ ì•Šì•˜ê³  ë”°ë¼ì„œ ë¹ˆ ë°°ì—´ì´ ë¨¼ì € ë Œë”ë§ë˜ì–´ ì˜¤ë¥˜ê°€ ë‚˜ëŠ”ê²ƒ**





DBì— ì ‘ê·¼í• ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì—ëŸ¬ë¥¼ í•´ê²°í•˜ë ¤ë©´ 2ê°€ì§€ ë°©ë²•ì´ ì¡´ì¬

1. try-catch

```js
export const home = async(req,res)=>{
  try{
    const videos=await Video.find({});
    return res.render("home",{pageTitle:"Home",videos});
  } catch(error){
    return res.render("server-error",{error});
  }
}
```

2. callbackì˜ error

```js
Video.find({},(error,videos)=>{
  if(error){
    return res.render("server-error");
  }
  return res.render("home",{pageTitle:"Home",videos});
});
```



### Role of Return

**returnì˜ ì¼ë°˜ì ì¸ ì—­í• ì€ ë°˜í™˜ê°’ì„ ë°˜í™˜í•˜ê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•˜ëŠ” ê²ƒ**ì´ë‹¤.

ê·¸ëŸ¬ë‚˜ ìš°ë¦¬ê°€ ì‘ì—…í•˜ëŠ” ë¬´ì–¸ê°€ë¥¼ ë Œë”ë§í•´ì¤„ë•ŒëŠ” ë°˜í™˜ê°’ì´ ì—†ë‹¤.

ë”°ë¼ì„œ returnì€ í•„ìˆ˜ì ì´ì§€ ì•Šë‹¤. ê·¸ëŸ¬ë‚˜, í•¨ìˆ˜ê°€ í™•ì‹¤íˆ ì¢…ë£Œë¨ì„ ì•Œë ¤ì£¼ê¸° ìœ„í•˜ì—¬ returnì„ ì“°ëŠ” ê²ƒì´ ê°€ë…ì„± ì¸¡ë©´ì—ì„œ ì¢‹ë‹¤.



```js
// ì´ ì½”ë“œë„ ì •ìƒì ìœ¼ë¡œ ë™ì‘
export const home = async (req, res) => {
  const videos = await Video.find({}).sort({ createdAt: "desc" });
  // return res.render()ê°€ ì•„ë‹˜
  res.render("home", {
    pageTitle: "Home",
    videos,
  });
};
```

ë§Œì¼ returnì„ ê¸°ì¬í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì‹¤ìˆ˜ë¡œ renderë¥¼ ë‘ë²ˆí•˜ê²Œ ë˜ë©´ í•¨ìˆ˜ê°€ ì‚´ì•„ì„œ renderë¥¼ ë‹¤ì‹œí•˜ëŠ” ì…ˆì´ë¯€ë¡œ ì—ëŸ¬ë°œìƒ

```js
export const home = async (req, res) => {
  const videos = await Video.find({}).sort({ createdAt: "desc" });
  res.render("home", {
    pageTitle: "Home",
    videos,
  });
  res.render("home", {});
};
```

ë”°ë¼ì„œ ê·¸ëƒ¥ ì† í¸í•˜ê²Œ returnìœ¼ë¡œ í•¨ìˆ˜ë¥¼ í™•ì‹¤í•˜ê²Œ ì£½ì´ì

```js
export const home = async (req, res) => {
  const videos = await Video.find({}).sort({ createdAt: "desc" });
  return res.render("home", {
    pageTitle: "Home",
    videos,
  });
  res.render("home", {}); // this will be never executed. function's already dead
};
```





---



## Create



### Making model

ë°ì´í„°ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ì ˆì°¨

1. ë°ì´í„°ë¥¼ ì…ë ¥ë°›ê¸° ìœ„í•œ view ì‘ì„± (front-end)
2. ë°ì´í„° ìƒì„±, DBì— ì €ì¥(back-end)





ë°ì´í„°ë¥¼ ì…ë ¥ë°›ê¸° ìœ„í•œ viewíŒŒì¼ì„ ìƒì„±í•˜ì.

```pug
extends base.pug 

block content 
    if errerMessage 
        span=errorMessage
    form(method="POST")
        input(placeholder="Title",required,type="text",name="title")
        input(placeholder="Desciption",required,type="text",name="description",minlength=20)
        input(placeholder="Hashtags, separated by comma",required,type="text",name="hashtags")
        input(type="submit",value="Upload Video")
```

ì „ì— ì‚´í´ë³´ì•˜ë“¯ì´, POST method formì€ req.bodyì— inputì˜ nameë“¤ë¡œ ì…ë ¥í•œ ë°ì´í„°ë“¤ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.





<img width="862" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/231ff4d7-c295-40da-ab7f-5c04ecce5024">

```js
console.log(req.body);
```

ì°¸ê³ ë¡œ req.bodyë¥¼ ì´ë ‡ê²Œ JSONì²˜ëŸ¼ ë‹¤ë£¨ê¸° ìœ„í•´ì„œëŠ” express.urlencoded({ extended: true })ì„ ì‚¬ì „ì— ë“±ë¡í•´ë‘ì–´ì•¼ í•œë‹¤.

<img width="372" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/c1f56ecd-ed35-4261-bf1c-3c99b888c3e6">



ì´ë ‡ê²Œ ì–»ì€ ë°ì´í„°ë¥¼ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ê°€ê³µí•´ì„œ ìƒˆë¡œìš´ video ëª¨ë¸ì„ ìƒì„±

```js
export const postUpload = async (req, res) => {
  const { title, description, hashtags } = req.body;
  const video = new Video({
    title,
    description,
    hashtags: hashtags.split(",").map((word) => `#${word}`),
    createdAt: Date.now(),
    meta: {
      views: 0,
      rating: 0,
    },
  });
  console.log(video);
  return res.redirect("/");
};
```

<img width="349" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/a52a41bf-5623-4728-93e0-ba07b46235bf">

**ë‹¨, ì§€ê¸ˆì€ video ëª¨ë¸ì„ ìƒì„±ë§Œ í•˜ê³  ì•„ì§ DBì—ëŠ” ì§‘ì–´ë„£ì§€ ì•Šì€ ìƒíƒœ**ì´ë‹¤.



---



### Validation of model

ìš°ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ì´ modelì„ ìƒì„±í•˜ê¸° ìœ„í•œ schemaë¥¼ ì •ì˜í•´ì™”ë‹¤.

```js
const videoSchema = new mongoose.Schema({
  title: { type: String, required: true, trim: true, maxLength: 80 },
  description: { type: String, required: true, trim: true, minLength: 20 },
  createdAt: {
    type: Date,
    required: true,
    default: Date.now,
  },
  hashtags: [{ type: String, trim: true }],
  meta: {
    views: { type: Number, default: 0 },
    rating: { type: Number, default: 0 },
  },
});
```

ê·¸ë¦¬ê³  ì´ schemaëŠ” ë°ì´í„°ë¥¼ ê²€ì¦í•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ titleì€ String íƒ€ì…ìœ¼ë¡œ ì •ì˜ë˜ì—ˆìœ¼ë¯€ë¡œ 5ë¡œ ì…ë ¥í•´ë„ "5"ë¡œ ë³€í™˜ë˜ë©°,

Number íƒ€ì…ì¸ viewsì— stringìœ¼ë¡œ ì…ë ¥í–ˆì„ ê²½ìš°ì—ëŠ” ìœ„ ê²½ìš°ì²˜ëŸ¼ ë³€í™˜ì´ ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìë™ ëˆ„ë½ëœë‹¤.

> mongooseê°€ mdelì„ ë°”íƒ•ìœ¼ë¡œ dataë¥¼ ê²€ì¦í•œë‹¤.



*Date.now

Date.now()ëŠ” í•¨ìˆ˜ë¥¼ ë°”ë¡œ ì‹¤í–‰í•œë‹¤. (X)

Date.nowëŠ” ëª½êµ¬ìŠ¤ê°€ Modelì„ ë§Œë“¤ë•Œ ì‹¤í–‰í•œë‹¤.(O)



*defaultë¡œ ê¸°ë³¸ ê°’ì„ ì¤„ ìˆ˜ ìˆë‹¤.





---



### Saving data



ë°ì´í„°ë¥¼ DBì— ì €ì¥í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆë‹¤.

1. modelì„ ë§Œë“  í›„ì— ì €ì¥(new->save)
2. ê·¸ëƒ¥ ë°”ë¡œ ì €ì¥(created)

```js
export const postUpload = async (req, res) => {
  const { title, description, hashtags } = req.body;
  const video = new Video({
    title,
    description,
    hashtags: hashtags.split(",").map((word) => `#${word}`),
    createdAt: Date.now(),
    meta: {
      views: 0,
      rating: 0,
    },
  });
  await video.save(); // ë°ì´í„°ë¥¼ DBì— ì €ì¥

  return res.redirect("/");
};
```

<img width="404" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/9f26067f-fc61-4a1b-9e8f-e783d24cc2f4">

ì‹¤ì œë¡œ DBì— ì €ì¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì—¬ê¸°ì„œ _id ë¶€ë¶„ì€ mongooseê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ê²ƒì´ë‹¤.



ì´ ë°©ì‹ì€ ë°ì´í„°ë¥¼ ìƒì„±í•œ ë’¤ì— ì´ë¥¼ DBì— ì €ì¥í•œ ë°©ì‹ì´ë‹¤.

create()ì„ í™œìš©í•´ì„œ ë°”ë¡œ ì €ì¥í•˜ëŠ” ë°©ì‹ë„ ìˆë‹¤.

```js
export const postUpload = async (req, res) => {
  const { title, description, hashtags } = req.body;
  try {
    await Video.create({
      title,
      description,
      hashtags: Video.formatHashtags(hashtags),
    });
    return res.redirect("/");
  } catch (error) {
    console.log(error);
    return res.render("upload", {
      pageTitle: "Upload Video",
      errorMessage: error._message,
    });
  }
};
```





---





### Validation check



formì˜ ìœ íš¨ì„± ê²€ì¦ì€ í”„ë¡ íŠ¸ì™€ ë°±ì—ì„œ ë‘˜ë‹¤ í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.

í”„ë¡ íŠ¸ì—ì„œëŠ” input íƒœê·¸ì˜ ì†ì„±ìœ¼ë¡œ ê²€ì¦ì„ í•´ì£¼ê³  (ë§Œì¼ ì•…ì˜ì  ì‚¬ìš©ìê°€ html ìˆ˜ì •í•˜ë©´ ê²€ì¦ì´ ìˆ˜í–‰ë˜ì§€ ì•ŠìŒ)

```pug
input(name="title",required,type="text");
```

ë°±ì—ì„œë„ ê²€ì¦ì„ ë‹¤ì‹œí•œë²ˆ í•´ì£¼ì.

```js
const dataSchema=new mongoose.Schema({
	title: {type:String,required:true}; // required ì†ì„± ë¶€ì—¬, ë§Œì¼ ë¹„ì–´ìˆë‹¤ë©´ DBì— ìƒì„±ë˜ì§€ ì•ŠìŒ
})
```







---



## Edit(getting data from DB)

ìš°ë¦¬ê°€ ë¹„ë””ì–´ë¥¼ ì—…ë¡œë“œ í–ˆë‹¤ë©´, ì´ë¥¼ ìˆ˜ì •í•  ìˆ˜ë„ ìˆì–´ì•¼ í•œë‹¤.

ì´ë•Œ ì´ ë¹„ë””ì–´ê°€ ê°€ì§€ëŠ” ê³ ìœ  idë¥¼ ì´ìš©í•´ í•´ë‹¹ ë¹„ë””ì˜¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

ê·¸ë¦¬ê³  ì´ë•Œ idë¥¼ ì •ê·œì‹ì„ ì´ìš©í•´ì„œ ì¶”ì¶œí•´ì•¼ í•œë‹¤.

### regex

![image](https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/8b8786e3-0208-43a3-8165-2c6c88667556)

ìœ„ mongoDB ê³µì‹ë¬¸ì„œì—ì„œ í™•ì¸ê°€ëŠ¥í•˜ë“¯ì´, idëŠ” 24ìë¦¬ì˜ 16ì§„ìˆ˜ë¡œ ì´ë£¨ì–´ì ¸ìˆë‹¤.



ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ ì•Œë§ì€ ì •ê·œì‹ì„ ì ìš©í•´ì„œ ë¼ìš°íŒ…ì„ í•˜ì

```js
import express from "express";
import {
  getEdit,
  postEdit,
  watch,
  getUpload,
  postUpload,
  deleteVideo,
} from "../controllers/videoController";
const videoRouter = express.Router();

videoRouter.get("/:id([0-9a-f]{24})", watch);

videoRouter.route("/:id([0-9a-f]{24})/edit").get(getEdit).post(postEdit);
videoRouter.route("/:id([0-9a-f]{24})/delete").get(deleteVideo);

videoRouter.route("/upload").get(getUpload).post(postUpload);

export default videoRouter;

```



```js
export const watch = async (req, res) => {
  const { id } = req.params;
  const video = await Video.findById(id);
  if (!video) {
    return res.render("404", {
      pageTitle: "video not found",
    });
  }
  return res.render("Watch", {
    pageTitle: video.title,
    video,
  });
};
```



### Hashtag issue

ë¹„ë””ì˜¤ì— í•´ì‰¬íƒœê·¸ë¥¼ ë‹¤ëŠ” ì‘ì—…ì„ í•´ì¤€ë‹¤ê³  í•˜ì.

```js
video.hashtags=video.hashtags.split(,).map((word)=>`#{word}`);
```

ê·¸ëŸ¬ë‚˜ ì´ ë°©ì‹ì€ ê³„ì†í•´ì„œ ë¬¸ìì˜ ë§¨ì•ì— #ê¸°í˜¸ë¥¼ ì¶”ê°€í•˜ê¸° ë•Œë¬¸ì—

#ì´ê²Œ

##ì´ë ‡ê²Œ ë˜ê³ 

###ê³„ì†í•´ì„œ

#######ì¶”ê°€ë  ìˆ˜ ìˆëŠ” ë¬¸ì œì ì´ ìˆë‹¤.

ë”°ë¼ì„œ ì‚¼í•­ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì.

```js
video.hashtags=hashtags.split(",").map((word)=>(word.startsWith("#")?word:`#${word}));
```

ì´ ì½”ë“œëŠ” startsWithë¥¼ ì´ìš©í•´ #ê°€ ë§¨ì•ì— ì—†ë‹¤ë©´ ì¶”ê°€í•´ì£¼ëŠ” ê°„ê²°í•œ ì¡°ê±´ë¬¸ì´ë‹¤.

---



### Editing data

findOne()í˜¹ì€ findById()ë¡œ íŠ¹ì • ë°ì´í„°ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆê³ 

í˜¹ì€ ì•„ë˜ì²˜ëŸ¼ findByIdAndUpdate()í•¨ìˆ˜ë¥¼ í†µí•´ ê²€ìƒ‰ê³¼ ìˆ˜ì •ì„ ë™ì‹œì— í•  ìˆ˜ ìˆë‹¤

> ## Syntax[![img](https://www.mongodb.com/docs/manual/assets/link.svg)](https://www.mongodb.com/docs/manual/reference/method/db.collection.findOneAndUpdate/#syntax)
>
> The [`findOneAndUpdate()`](https://www.mongodb.com/docs/manual/reference/method/db.collection.findOneAndUpdate/#mongodb-method-db.collection.findOneAndUpdate) method has the following form:
>
> ```js
> db.collection.findOneAndUpdate(
>     <filter>,
>     <update document or aggregation pipeline>, // Changed in MongoDB 4.2
>     {
>       writeConcern: <document>,
>       projection: <document>,
>       sort: <document>,
>       maxTimeMS: <number>,
>       upsert: <boolean>,
>       returnDocument: <string>,
>       returnNewDocument: <boolean>,
>       collation: <document>,
>       arrayFilters: [ <filterdocument1>, ... ]
>     }
> )
> ```

```js
export const postEdit = async (req, res) => {
  const { id } = req.params;
  const { title, description, hashtags } = req.body;
  const video = await Video.exists({ _id: id });
  if (!video) {
    return res.render("404", {
      pageTitle: "video not found",
    });
  }

  await Video.findByIdAndUpdate(id, {
    title,
    description,
    hashtags: Video.formatHashtags(hashtags),
  });

  return res.redirect(`/videos/${id}`);
};
```







---



## Delete



> **ì‚­ì œ ê¸°ëŠ¥** êµ¬í˜„ ì ˆì°¨
>
> 1. formì— ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
> 2. Routing
> 3. Controlling

viewì— ì‚­ì œ ë²„íŠ¼ì„ ì¶”ê°€í•˜ì

```pug
extends base.pug

block content 
    div
        p=video.description
        small=video.createdAt
    a(href=`${video.id}/edit`) Edit Video &rarr;
    br
    a(href=`${video.id}/delete`) Delete Video &rarr;
```

ë¼ìš°íŒ… ì²˜ë¦¬ í•´ì£¼ì

```js
videoRouter.route("/:id([0-9a-f]{24})/delete").get(deleteVideo);
```

ì»¨íŠ¸ë¡¤ëŸ¬ ì²˜ë¦¬ë„

```js
export const deleteVideo = async (req, res) => {
  const { id } = req.params;
  await Video.findByIdAndDelete(id);
  return res.redirect("/");
};
```

remove()ì™€ delete()ëŠ” ë³„ì°¨ì´ ì—†ì§€ë§Œ mongoì—ì„œëŠ” delete() ì‚¬ìš©ì„ ê¶Œì¥í•œë‹¤.



---



# Bonus : Search



ë¹„ë””ì˜¤ ê²€ìƒ‰ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì.

> **ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„** ì ˆì°¨
>
> 1. ê²€ìƒ‰ view êµ¬í˜„
> 2. Routing
> 3. Countrolling

ê²€ìƒ‰ viewë¥¼ êµ¬í˜„í•˜ì.

```pug
extends base.pug
include mixins/video

block content 
    form(method="GET")
        input(placeholder="Search by title",type="text",name="keyword")
        input(type="submit",value="Search now")
    each video in videos 
        +video(video)
```

ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ GET methodë¡œ ì¸í•´ ì¿¼ë¦¬ê°€ URLë¡œ ì „ì†¡ëœë‹¤.

<img width="304" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/e89c3bd4-63ba-4ae5-8599-17ad19ab9596">

ê·¸ë¦¬ê³  ì´ëŠ” req.query()ë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤.

```js
console.log(req.query);
// OUTPUT : { keyword: 'HELLO' }
```



ì´ë¥¼ ì´ìš©í•´ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ êµ¬ì„±í•˜ì

```js
globalRouter.get("/search", search);

export const search = async (req, res) => {
  const { keyword } = req.query;
  let videos = [];
  if (keyword) {
    	videos = await Video.find({
      title: {
        $regex: new RegExp(keyword, "i"),
      },
    });
  }
  return res.render("search", { pageTitle: "Search", videos });
};
```

ì—¬ê¸°ì„œ ë§Œì¼ search í˜ì´ì§€ì— ì²˜ìŒ ì ‘ê·¼í•  ê²½ìš° req.queryì˜ keywordëŠ” undefinedì´ê¸° ë•Œë¬¸ì— ì˜¤ë¥˜ë°©ì§€ë¥¼ ìœ„í•´ if ì²˜ë¦¬ë¥¼ í•´ì£¼ì—ˆë‹¤.



---







# ETC





## M/W in mongoose

mongooseì—ì„œë„ ë¯¸ë“¤ì›¨ì–´ê°€ ì¡´ì¬í•˜ëŠ”ë°, objectê°€ DBì— ì €ì¥ë˜ê¸° ì „ì— ì‘ì—…ì„ í•´ì£¼ëŠ” ê²ƒì´ë‹¤

[mongoose document](https://mongoosejs.com/docs/middleware.html#pre)

> ## [Pre](https://mongoosejs.com/docs/middleware.html#pre)
>
> Pre middleware functions are executed one after another, when each middleware calls `next`.
>
> ```javascript
> const schema = new Schema({ /* ... */ });
> schema.pre('save', function(next) {
>   // do stuff
>   next();
> });
> ```



```js
videoSchema.pre("save",async function(){
	console.log("We are about to save : ",this);
	this.hashtags=this.hashtags[0].split(",").map((word)=>(word.startsWith("#")?word:`#${word}));
})
```

ì´ë¥¼ í†µí•´ ì‚¬ì „ ì‘ì—…ì„ ë¯¸ë“¤ì›¨ì–´ì—ì„œ í•´ì¤„ ìˆ˜ ìˆë‹¤.



ê·¸ë¦¬ê³  ì´ í•´ì‰¬íƒœê·¸ ì‘ì—…ì„ ë”°ë¡œ í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ ì œì‘í•  ê²½ìš°ì—ëŠ” importì™€ exportê°€ í•„ìš”í•˜ë‹¤

```js
export const formatHashtags=(hashtags)=>
	hashtags.split(",").map((word)=>(word.startsWith("#")?word:`#${word}));
	
...
await Video.findByIdAndUpdate(id,{
	title, description, hashtags:formatHashtags(hashtags),
})
```



ì´ë•Œ í•¨ìˆ˜ë¥¼ ë” ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆë‹¤.

---



## Statics in mongoose

> ## [Statics](https://mongoosejs.com/docs/guide.html#statics)
>
> You can also add static functions to your model. There are three equivalent ways to add a static:
>
> - Add a function property to the second argument of the schema-constructor (`statics`)
> - Add a function property to `schema.statics`
> - Call the [`Schema#static()` function](https://mongoosejs.com/docs/api/schema.html#schema_Schema-static)
>
> ```javascript
> // define a schema
> const animalSchema = new Schema({ name: String, type: String },
>   {
>   // Assign a function to the "statics" object of our animalSchema through schema options.
>   // By following this approach, there is no need to create a separate TS type to define the type of the statics functions.
>     statics: {
>       findByName(name) {
>         return this.find({ name: new RegExp(name, 'i') });
>       }
>     }
>   });
> 
> // Or, Assign a function to the "statics" object of our animalSchema
> animalSchema.statics.findByName = function(name) {
>   return this.find({ name: new RegExp(name, 'i') });
> };
> // Or, equivalently, you can call `animalSchema.static()`.
> animalSchema.static('findByBreed', function(breed) { return this.find({ breed }); });
> 
> const Animal = mongoose.model('Animal', animalSchema);
> let animals = await Animal.findByName('fido');
> animals = animals.concat(await Animal.findByBreed('Poodle'));
> ```
>
> Do **not** declare statics using ES6 arrow functions (`=>`). Arrow functions [explicitly prevent binding `this`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions#No_binding_of_this), so the above examples will not work because of the value of `this`.
>
> 



ì˜ˆì‹œ ì½”ë“œ

```js
//static function ë“±ë¡
videoSchema.static("formatHashtags",function(hashtags){
  return hashtags.split(",").map((word)=>(word.startsWith("#")?word:`#${word}`))
})

//static functino call
await Video.create({
		title,
		desciption,
		hashtags: Video.formatHashtags(hashtags),
})
```







---







## Mongosh command

```js
mongosh ì‚¬ìš©
> mongosh

ë‚´ê°€ ê°€ì§„ DB ë³´ê¸°
> show dbs

ì‚¬ìš©í•  DB ì„ íƒ
> use myDBName

DB collection ë³´ê¸°
> show collections

DB collectionì˜ documents ë³´ê¸°
> db.collectionName.find()

DB collectionì˜ ëª¨ë“  documents ì œê±°
> db.collectionName.remove({})
```

---



## How to get info from FE in BE

FEì—ì„œ BEë¡œ ì •ë³´ë¥¼ ë³´ë‚´ëŠ” ë°©ë²•ì€ í¬ê²Œ 3ê°€ì§€ê°€ ìˆë‹¤. í•´ë‹¹ ë°©ì‹ì˜ ì •ë³´ë¥¼ ë°›ëŠ” ë²•ë„ ì •ë¦¬í•˜ì



1. URL parameterë¡œ ë³´ë‚´ëŠ” ê²½ìš° -> req.params
2. formì˜ POST methodë¡œ ë³´ë‚´ëŠ” ê²½ìš° -> req.body (m/w ë“±ë¡í•„ìš”)
3. URL GET methodë¡œ ë³´ë‚´ëŠ” ê²½ìš° -> req.query



[ì¶”ì²œ í¬ìŠ¤íŒ…](https://inpa.tistory.com/entry/EXPRESS-%F0%9F%93%9A-reqparams-reqquery-reqbody-%F0%9F%A4%94-%EC%A0%95%EB%A6%AC)



---



# Recap

íŒŒì¼ì„ server.jsì™€ init.jsë¡œ ë¶„ë¦¬ -> ê´€ë¦¬ ìš©ì´

CRUDì˜ ì„¸ë¶€ì ì¸ ì‚¬í•­ì„ ì§ì ‘ êµ¬í˜„ 

ì´ë•Œ DB ì²˜ëŸ¼ ì™¸ë¶€ resourceì— ì ‘ê·¼í•  ë•ŒëŠ” ë¹„ë™ê¸°ì  ë°©ì‹ì‚¬ìš©



mongooseì— m/wë¡œ ë°ì´í„° ì „ì²˜ë¦¬ë¥¼ í•´ë„ ë˜ê³ , static functionì„ í†µí•´ ì „ì²˜ë¦¬ë¥´ ã„¹í•´ë„ ì£ˆë‹¤.





---



# Topic to research Later



## Regulx

## Syn vs Asyn in aspect of promise

