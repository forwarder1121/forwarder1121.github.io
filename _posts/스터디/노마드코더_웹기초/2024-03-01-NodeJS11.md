---
title: "Node JS #11"

excerpt: "ì„¸ì…˜ DB ì„¤ì •ê³¼ ì¿ í‚¤, í™˜ê²½ ë³€ìˆ˜"

categories:
    - webBase
---

ë¡œê·¸ì¸ ê¸°ëŠ¥ê³¼ ê´€ë ¨ëœ ê°„ë‹¨í•œ ë³µìŠµì„ í•´ë³´ì.

ìš°ë¦¬ê°€ ë§Œë“  ì„¸ì…˜ dataëŠ” cookieì— ì €ì¥ë˜ì§€ ì•Šê³ , BEì— ì €ì¥ëœë‹¤.

ê·¸ë˜ì„œ BEì—ì„œëŠ” ì´ ì„¸ì…˜ DBì— ë°ì´í„°ë“¤ì„ ì €ì¥í•œë’¤ ì„¸ì…˜ IDë¥¼ FEì—ê²Œ cookie í˜•íƒœë¡œ ì¤€ë‹¤.

ì´ì œ BEì—ì„œ ì„¸ì…˜ì„ DBì— ì €ì¥í•˜ëŠ” ê²ƒì„ êµ¬í˜„í•´ë³´ì.

ì§€ê¸ˆì€ ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ê²Œ ë˜ë©´ ëª¨ë“  ì„¸ì…˜ ì •ë³´ê°€ ë‚ ë¼ê°„ë‹¤.

mongoDBì˜ ì„¸ì…˜ ì €ì¥ì†Œì¸ connect-mongoë¥¼ ì‚¬ìš©í•˜ì.

# Connect-mongo

[link](https://www.npmjs.com/package/connect-mongo)

> MongoDB session store for [Connect](https://github.com/senchalabs/connect) and [Express](http://expressjs.com/) written in Typescript.

> **Install**
>
> ```js
> $ npm install connect-mongo
> ```

```js
import session from "express-session";
import MongoStore from "connect-mongo";

app.use(
    session({
        secret: process.env.COOKIE_SECRET,
        resave: false,
        saveUninitialized: false,
        store: MongoStore.create({
            mongoUrl: process.env.DB_URL,
        }), // MongoUrlì˜ ìœ„ì¹˜ì— ìš°ë¦¬ ì„¸ì…˜ì„ ì €ì¥, ex) mongodb://127.0.0.1:23421/wetube
        // ë‹¤ë§Œ ë³´ì•ˆì˜ ìœ„í•´ ë”°ëŸ¬ .env íŒŒì¼ì„ ë§Œë“¤ì–´ ìœ„ì¹˜ë¥¼ ìˆ¨ê¹€
    })
);
```

<img width="549" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/4fe0b85f-c161-4011-b3d7-be3d8e2d451d">

ì´ë ‡ê²Œ ì‹¤ì œë¡œ DBì— ì„¸ì…˜ ì •ë³´ê°€ ì €ì¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ ìš°ë¦° ì„œë²„ê°€ ì¬ë¶€íŒ…ë˜ì–´ë„ ì„¸ì…˜ ì •ë³´ë¥¼ ë‚ ë¦¬ì§€ ì•Šì„ ìˆ˜ ìˆê²Œ ëœë‹¤.

ì´ connection-mongo íŒ¨í‚¤ì§€ì˜ ì˜µì…˜ë“¤ì„ ì•Œì•„ë³´ì.

## saveUninitialized

> Forces a session that is "uninitialized" to be saved to the store. A session is uninitialized when it is new but not modified. Choosing `false` is useful for implementing login sessions, reducing server storage usage, or complying with laws that require permission before setting a cookie. Choosing `false` will also help with race conditions where a client makes multiple parallel requests without a session.
>
> The default value is `true`, but using the default has been deprecated, as the default will change in the future. Please research into this setting and choose what is appropriate to your use-case.

ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ì„¸ì…˜ì„ ì €ì¥í•  ê²ƒì¸ì§€ì˜ ì—¬ë¶€ë¥¼ ì²´í¬í•œë‹¤.

ë§Œì¼ ìš°ë¦¬ì˜ ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•˜ëŠ” ìµëª…ì˜ ëª¨ë“  ì‚¬ìš©ìë“¤ì—ê²Œ ì„¸ì…˜ì„ ë§Œë“¤ì–´ ì„¸ì…˜ IDë¥¼ ë°œê¸‰í•´ì¤€ë‹¤ëŠ” ê²ƒì€ ë§¤ìš° í° ë¹„ìš©ì´ ë“œëŠ” ì‘ì—…ì¼ ê²ƒì´ë‹¤.

ë”°ë¼ì„œ ë¡œê·¸ì¸í•œ ìœ ì €ë§Œ ê¸°ì–µí•˜ë©´ ë¹„êµì  ì ì€ ë¹„ìš©ì´ ë“¤ ê²ƒì´ê³ , ì´ë¥¼ ì´ ì˜µì…˜ì„ ì´ìš©í•´ êµ¬í˜„í•œë‹¤.

```js
saveUninitialized: true;
```

ì´ ìƒíƒœì—ì„œëŠ” ì‚¬ì´íŠ¸ë¥¼ ìµëª…ì˜ ë¸Œë¼ìš°ì €(ë¡œê·¸ì¸ ìœ ì €ê°€ ì•„ë‹ˆë¼ ì‚¬ìš©ìë¥¼ ê¸°ì–µí•  ê°€ì¹˜ê°€ ì—†ëŠ” ìƒíƒœ)ì—ì„œë„

<img width="537" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/3e76f294-5d99-41a0-8a88-a1a4a4727edb">

ì„¸ì…˜ IDê°€ ë°œê¸‰ë˜ì–´ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

![image-20240303003318950](/Users/forwarder1121/Library/Application Support/typora-user-images/image-20240303003318950.png)

ì‹¤ì œ DBì—ì„œ ì´ ì €ì¥í•  ê°€ì¹˜ê°€ ì—†ëŠ” ë¸Œë¼ìš°ì €ì˜ ì •ë³´ë¥¼ ì—´ì‹¬íˆ ì €ì¥í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆê³ , ë¹„ìš©ì´ ì“¸ë°ì—†ì´ ë§ì´ ë“¤ê²ƒì´ë‹¤.

```js
 saveUninitialized: false,
```

ì´ ì˜µì…˜ì— falseë¥¼ ì£¼ë©´ ì´ˆê¸°í™” ë˜ì§€ ì•Šì€ ì„¸ì…˜ì€ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

<img width="546" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/ca22a029-6f25-4259-afb7-98d7cd4a80a2">

<img width="246" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/6002076e-68ea-46f4-b043-bd42c6aa34d2">

<img width="1291" alt="image" src="https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/11625a86-27d2-431c-868e-62d5d1bc71aa">

ì´ë ‡ê²Œ ë¡œê·¸ì¸ì„ í•´ì•¼ë§Œ ì„¸ì…˜ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ë¯€ë¡œ ë¹„ë¡œì†Œ DBì— ì„¸ì…˜ì´ ì €ì¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆê³ , ë”°ë¼ì„œ ë¸Œë¼ìš°ì €ëŠ” ì„¸ì…˜ IDë¡œ ì¿ í‚¤ë¡œ ë°›ëŠ”ë‹¤.

ê·¸ë ‡ë‹¤ë©´ ìš°ë¦¬ëŠ” ì–´ë””ì„œ ì„¸ì…˜ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•´ì£¼ì—ˆì„ê¹Œ?

ë°”ë¡œ ë¡œê·¸ì¸ì²˜ë¦¬ í•¸ë“¤ëŸ¬ì—ì„œë‹¤!

```js
export const postLogin = async (req, res) => {
    const { username, password } = req.body;
    const pageTitle = "Login";
    //check if account exists
    const user = await User.findOne({ username, socialOnly: false });
    if (!user) {
        return res.status(404).render("login", {
            pageTitle,
            errorMessage: "An account with this username does not exists.",
        });
    }

    //check if password correct
    const checkPassword = await bcrypt.compare(password, user.password);
    if (!checkPassword) {
        return res.status(404).render("login", {
            pageTitle,
            errorMessage: "Wrong password",
        });
    }
    //session initialized!
    req.session.loggedIn = true;
    req.session.user = user;

    return res.redirect("/");
};
```

ë”°ë¼ì„œ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

1. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ì •ë³´ ì…ë ¥
2. ë¡œê·¸ì¸ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ í˜¸ì¶œ
3. ë¡œê·¸ì¸ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ê°€ ì„¸ì…˜ ì´ˆê¸°í™”
4. ì„¸ì…˜ì´ ì´ˆê¸°í™” ë˜ì—ˆìœ¼ë¯€ë¡œ ì„œë²„ ì„¸ì…˜ DBì— ì €ì¥
5. ì„œë²„ëŠ” ë¸Œë¼ìš°ì €ì— ì„¸ì…˜ ID ë°œê¸‰

## resave

ì„¸ì…˜ì— ë³€ê²½ì‚¬í•­ì´ ì—†ì„ ë•Œ, ì„¸ì…˜ì„ ë‹¤ì‹œ ì €ì¥í• ì§€ì˜ ìœ ë¬´ë¥¼ ê²°ì •í•œë‹¤.

ì„¸ì…˜ì˜ TTLì„ ì„¤ì •í•´ì£¼ëŠ” ê¸°ëŠ¥ì´ ì—†ìœ¼ë©´ resave:trueë¡œ ë‘ì–´ ë§¤ requestë§ˆë‹¤ ì„¸ì…˜ì„ ì—…ë°ì´íŠ¸ ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

ë‹¤ë§Œ, ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ”ë°ë„ ì„¸ì…˜ì„ ê³„ì† ì €ì¥í•˜ë©´ ë¹„íš¨ìœ¨ì ì´ë¯€ë¡œ resave:falseë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

---

# Cookie

ì¿ ê¸°ì˜ ì†ì„±ì—ëŠ” ì•„ë˜ì™€ ê°™ì€ ì†ì„±ë“¤ì´ ìˆë‹¤.

![image](https://github.com/forwarder1121/forwarder1121.github.io/assets/66872094/2d89ca1d-f00b-4d85-b3b1-26842f344b75)

Domain : ì¿ í‚¤ë¥¼ ë°œí–‰í•´ì£¼ëŠ” ê¸°ê´€ ë„ë©”ì¸, êµ¬ê¸€ì´ë©´ êµ¬ê¸€ì—ì„œë§Œ í†µìš©ë˜ëŠ” ì¿ í‚¤

Path : ê²½ë¡œ

> Secret : ë¹„ë°€í‚¤
>
> This is the secret used to sign the session cookie. This can be either a string for a single secret, or an array of multiple secrets. If an array of secrets is provided, **only the first element will be used to sign** the session ID cookie, while **all the elements will be considered when verifying the signature** in requests. The secret itself should be not easily parsed by a human and would best be a random set of characters

> Expires : ë§Œë£Œ ì‹œì 
>
> Specifies the number (in milliseconds) to use when calculating the `Expires Set-Cookie` attribute. This is done by taking the current server time and adding `maxAge` milliseconds to the value to calculate an `Expires` datetime. By default, no maximum age is set.
>
> If both `expires` and `maxAge` are set in the options, then the last one defined in the object is what is used. `maxAge` should be preferred over `expires`.
>
> ```js
> cookie: {
>             maxAge: 1000 * 60 * 60 * 24 * 30,
>         },
> ```

---

# Enviroment Variables : dotenv

ìœ„ì—ì„œ ì¿ í‚¤ì—ëŠ” Secret ê°’ì´ ìˆë‹¤ê³  í–ˆë‹¤. ë˜í•œ MongoDBë¥¼ ì—°ê²°í•˜ëŠ” ê³¼ì •ì—ì„œ DB Urlì´ ì…ë ¥ë˜ëŠ”ë°, ë§Œì¼ ì´ëŸ¬í•œ ê°’ë“¤ì´ ê¹ƒí—ˆë¸Œì— ì˜¬ë¦´ë•Œ ê·¸ëŒ€ë¡œ ë…¸ì¶œëœë‹¤ë©´ ë³´ì•ˆìƒ ì·¨ì•½í•´ì§ˆ ê²ƒì´ë‹¤.

ë”°ë¼ì„œ ìš°ë¦° ì´ëŸ° í™˜ê²½ ë³€ìˆ˜ì˜ ê°’ì„ ìˆ¨ê²¨ì•¼ í•œë‹¤.

dotenv íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•´ ì´ë¥¼ ì‰½ê²Œ êµ¬í˜„í•˜ì.

```js
ğŸŒ± Install
# install locally (recommended)
npm install dotenv --save
```

```js
ğŸ—ï¸ Usage
how to use dotenv video tutorialyoutube/@dotenvorg
Create a .env file in the root of your project:

S3_BUCKET="YOURS3BUCKET"
SECRET_KEY="YOURSECRETKEYGOESHERE"
As early as possible in your application, import and configure dotenv:

require('dotenv').config()
console.log(process.env) // remove this after you've confirmed it is working
.. or using ES6?

import 'dotenv/config'
That's it. process.env now has the keys and values you defined in your .env file:

```

ì—¬ê¸°ì„œ importë¥¼ ê°€ëŠ¥í•œí•œ ë¹ ë¥¸ ì‹œì ì— í•˜ë¼ê³  í–ˆëŠ”ë°,

package.jsonì„ ë³´ë©´

```js
"scripts": {
        "dev": "nodemon --exec babel-node src/init.js"
    },
```

ìš°ë¦¬ëŠ” src/init.jsë¥¼ ì‹œì‘íŒŒì¼ë¡œ ì„œë²„ë¥¼ êµ¬ë™í•˜ë¯€ë¡œ ì´ê²ƒì´ ê°€ì¥ ë¹ ë¥¸ ì‹œì ì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ init.jsì—ì„œ

```js
import "dotenv/config";
```

importë¥¼ ì‹œì¼œì£¼ë©´ ëœë‹¤. ë§Œì¼ ë‹¤ë¥¸ íŒŒì¼ì— importí•´ì„œ ë’¤ëŠ¦ì€ ì‹œì ì— envê°€ ì‚¬ìš©ì‹œì‘ë  ê²½ìš°, ê·¸ ì•ì—ì„œëŠ” env ë³€ìˆ˜ë¥¼ ì´ìš©í•  ìˆ˜ ì—†ê²Œë˜ì–´ undefinedê°€ ëœ¬ë‹¤.

í™˜ê²½ë³€ìˆ˜ë“¤ì„ ì €ì¥í•  íŒŒì¼ì¸ .envíŒŒì¼ì„ ìƒì„±í•˜ì.

ì´ë•Œ, **.envì—ëŠ” ê´€ë¡€ìƒ ëŒ€ë¬¸ìë¡œ ì ëŠ”ë‹¤**

```js
//.env
COOKIE_SECRET=sdfds2389n3njk2l
DB_URL=mongodb://127.0.0.1:27017/wetube
//GH_CLIENTëŠ” SECRETì´ ì•„ë‹ˆì§€ë§Œ ì ‘ê·¼ì„±ì„ ìœ„í•´ ì—¬ê¸°ë‹¤ ì •ì˜
GH_CLIENT=20f72f7fd7a9a67cd510
GH_SECRET=f483dcbc82455c2e43f828ef9bcd104f5a8ee6b4
```

ê·¸ë¦¬ê³  ì´ íŒŒì¼ì„ ê¹ƒí—ˆë¸Œì— ì—…ë¡œë“œí•˜ì§€ ì•Šê¸° ìœ„í•´ .gitignoreíŒŒì¼ì— ê¸°ì¬í•˜ì.

```js
//.gitignore
/node_modules
.env
/uploads
```

ê·¸í›„ ëª¨ë“  íŒŒì¼ì—ì„œ process.env.{í‚¤ ê°’} ìœ¼ë¡œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```js
console.log(process.env.COOKIE_SECRET);
//OUTPUT : sdfds2389n3njk2l
```
